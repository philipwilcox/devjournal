# 2018.01 Android Widget Development

## 2018.01.29

I installed Android Studio per the instructions on the website. I'm
pretty familiar with IntelliJ, so not bothering documenting all that.

My initial project idea is to learn about widgets and the system APIs
for creating a widget for dealing with alarms and timers. We'll see
how possible/practical this is.

I decided to use the latest API, 27, for Android 8.1 since I'm
interested in learning the newest recommendations and don't need my
personal apps running on other devices.

I also decided to use Kotlin since I've played with it before as a
Java alternative and like its reduced verbosity.

40 minutes of downloading and configuring (mostly downloading) got me
this starting point repo: https://github.com/philipwilcox/ClockManager

Note that I created this as an empty activity, not knowing anything
about them to guide my starting point otherwise.

Trying to run it out of the box gives me a dialog showing that I
already have a "Nexus 5X API 27 x86" virtual device, which seems fine
for now. I'll connect my phone later.
* It blows up with "Missing initial data partition file" wtf...
* https://stackoverflow.com/questions/47895124/emulator-emulator-error-missing-initial-data-partition-file well that's stupid, but yeah, running a second time fixed that, but it's actually failing on trying to load openGL drivers!
* Setting it to software graphics driver fixes that, seems there's an old bug that I need to work around for getting hardware graphics working later with Intel drivers... https://bbs.archlinux.org/viewtopic.php?id=213192

I'll pick up there later, bleh.

## 2018.01.30

Left off from yesterday with an emulator that wouldn't boot at all.
* Fixed booting with software graphics by creating a new Pixel profile emulator running Android 26 API x86\_64 image. Not sure if API version change or x86\_64 vs x86 that did the trick.
* Hardware graphics mode problem still exists.
  * Looking at https://askubuntu.com/questions/867081/android-studio-buggy-after-upgrade-to-16-10
  * Trying the `export ANDROID_EMULATOR_USE_SYSTEM_LIBS=1` in `.profile` suggestion. No luck even after restarting Android studio.
  * This did the trick, sigh:
    ```bash
    ðŸ˜Š  [Tue Jan 30 12:45:20] philip@thinkphil25:~/Android 
    ðŸ’°  cd ~/Android/Sdk/emulator/lib64
    ðŸ˜Š  [Tue Jan 30 12:45:58] philip@thinkphil25:~/Android/Sdk/emulator/lib64 
    ðŸ’°  mv libstdc++ libstdc++.bad
    ```

Now that I have an environment, I'll jump into coding later. Frustrating setup to have to debug before I can even do a hello world.

## 2018.02.01

Today I picked up by starting to write my own code. First task: try to
read the next alarm time from the system. One stackoverflow post
mentioned AlarmManager,
https://developer.android.com/reference/android/app/AlarmManager.html,
though it's unclear if this will work for system level alarms or just
scheduling events for the app.

Ended up with this after some kotlin kung-fu to convert the Java
example commands. I learned the cast from the interactive debugger:
```kotlin
var alarmManager = applicationContext.getSystemService(Context.ALARM_SERVICE);
var nextAlarm = (alarmManager as AlarmManager).nextAlarmClock
```

By default in an empty simulator, nextAlarm is null. Had to do a brief
digression to learn how to use the log: `Log.e` will print an
error-level log to the Logcat tab in Android Studio (which will color
it red for noticability), but I got my emulator confused and had to
restart Android Studio to get it to find the process correctly.

Next task: change the emulator to have an alarm set, and see if it
still comes back as `null`. *This works!* It gives me a non-null
`AlarmClockInfo` object with a numeric mTriggerTime. I can get that
trigger time into a string like so:
```kotlin
DateUtils.formatDateTime(applicationContext, nextAlarm.triggerTime, DateUtils.FORMAT_SHOW_DATE or DateUtils.FORMAT_SHOW_TIME)
```

Then `1517578200000` turns into `February 2, 8:30 AM`.

Note the "or" bitwise operator in Kotlin. :|

Speaking of, this looks handy:
https://kotlinlang.org/docs/reference/idioms.html - like this
if-not-null shorthand:
```kotlin
val files = File("Test").listFiles()

println(files?.size)
```
or execute if not null oddity:
```kotlin
val value = ...

value?.let {
    ... // execute this block if not null
}
```
(Are we sure this one's so great? Here's some discussion: https://discuss.kotlinlang.org/t/let-vs-if-not-null/3542 -- interesting how it turns the thing being tested into `it`, too, which shortens things a tiny bit in trivial cases but would be cool for more complex nested checks.)


